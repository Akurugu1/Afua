<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Subway Surfers Ultra</title>
<style>
body { margin:0; overflow:hidden; background:#000; font-family:Arial;}
canvas { display:block; margin:auto; background:#111;}
#ui {
  position:absolute;
  top:10px;
  left:50%;
  transform:translateX(-50%);
  color:white;
  text-align:center;
}
button {
  padding:8px 14px;
  margin:4px;
  border:none;
  background:#444;
  color:white;
  cursor:pointer;
}
button:hover { background:#666; }
</style>
</head>
<body>
<div id="ui"></div>
<canvas id="game"></canvas>

<script>
// ===================== SETUP =====================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 420;
canvas.height = 700;

const lanes = [-1, 0, 1];
let currentLane = 0;

let state = "menu"; // menu, shop, game, gameover

let speed = 6;
let score = 0;
let shield = false;
let shieldTimer = 0;

let bgOffset = 0;

let data = JSON.parse(localStorage.getItem("runnerSave")) || {
  coins:0,
  highScore:0,
  skin:"lime",
  owned:["lime"]
};

function save() {
  localStorage.setItem("runnerSave", JSON.stringify(data));
}

// ===================== AUDIO =====================
const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

function tone(freq, dur=0.1, vol=0.1){
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);
  osc.frequency.value=freq;
  gain.gain.value=vol;
  osc.start();
  osc.stop(audioCtx.currentTime+dur);
}

// Background music loop
function musicLoop(){
  if(state!=="game") return;
  tone(220,0.2,0.05);
  setTimeout(()=>tone(330,0.2,0.05),200);
  setTimeout(()=>tone(440,0.2,0.05),400);
  setTimeout(musicLoop,800);
}

// ===================== PLAYER =====================
let player = {
  x:0,
  y:550,
  vy:0,
  w:40,
  h:60,
  grounded:true,
  frame:0
};

// ===================== OBJECTS =====================
let obstacles=[];
let coins=[];
let powerups=[];

// ===================== CONTROLS =====================
document.addEventListener("keydown", e=>{
  if(state==="menu" && e.code==="Space") startGame();
  if(state==="game"){
    if(e.code==="ArrowLeft" && currentLane>-1) currentLane--;
    if(e.code==="ArrowRight" && currentLane<1) currentLane++;
    if(e.code==="ArrowUp" && player.grounded) jump();
  }
  if(state==="gameover" && e.code==="Space") state="menu";
});

let touchStartX=0, touchStartY=0;
canvas.addEventListener("touchstart", e=>{
  touchStartX=e.touches[0].clientX;
  touchStartY=e.touches[0].clientY;
});
canvas.addEventListener("touchend", e=>{
  let dx=e.changedTouches[0].clientX-touchStartX;
  let dy=e.changedTouches[0].clientY-touchStartY;
  if(state==="game"){
    if(Math.abs(dx)>Math.abs(dy)){
      if(dx>30 && currentLane<1) currentLane++;
      if(dx<-30 && currentLane>-1) currentLane--;
    } else if(dy<-30) jump();
  }
});

// ===================== GAME LOGIC =====================
function jump(){
  player.vy=-16;
  player.grounded=false;
  tone(600);
}

function spawn(){
  let lane = lanes[Math.floor(Math.random()*3)];
  obstacles.push({lane, z:1});
  if(Math.random()<0.7) coins.push({lane,z:1});
  if(Math.random()<0.15) powerups.push({lane,z:1});
}

function startGame(){
  state="game";
  score=0;
  speed=6;
  obstacles=[]; coins=[]; powerups=[];
  musicLoop();
}

function update(){
  if(state!=="game") return;

  speed+=0.002;
  bgOffset+=speed;
  score++;

  player.vy+=0.8;
  player.y+=player.vy;
  if(player.y>=550){
    player.y=550;
    player.vy=0;
    player.grounded=true;
  }

  player.frame+=0.2;

  [obstacles,coins,powerups].forEach(arr=>{
    for(let i=arr.length-1;i>=0;i--){
      arr[i].z-=0.02*speed;
      if(arr[i].z<=0){
        if(arr===obstacles && arr[i].lane===currentLane && !shield){
          state="gameover";
          data.highScore=Math.max(score,data.highScore);
          save();
          tone(120,0.5);
        }
        if(arr===coins && arr[i].lane===currentLane){
          data.coins++;
          tone(900);
        }
        if(arr===powerups && arr[i].lane===currentLane){
          shield=true;
          shieldTimer=200;
          tone(1200);
        }
        arr.splice(i,1);
      }
    }
  });

  if(shield){
    shieldTimer--;
    if(shieldTimer<=0) shield=false;
  }

  if(score%100===0) spawn();
}

// ===================== DRAW =====================
function drawParallax(){
  ctx.fillStyle="#000";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  // Far buildings
  ctx.fillStyle="#111";
  for(let i=0;i<20;i++){
    ctx.fillRect(i*30,(bgOffset*0.2+i*40)%700,20,200);
  }

  // Mid layer
  ctx.fillStyle="#222";
  for(let i=0;i<20;i++){
    ctx.fillRect(i*40,(bgOffset*0.4+i*60)%700,30,300);
  }

  // Ground
  ctx.fillStyle="#333";
  ctx.fillRect(0,600,420,100);
}

function project(lane,z){
  let scale = 1/(z+0.1);
  let x = 210 + lane*100*scale;
  let y = 600 - 400*scale;
  return {x,y,scale};
}

function draw(){
  drawParallax();

  if(state==="menu"){
    ui.innerHTML=`<h1>Subway Ultra</h1>
    <button onclick="startGame()">Play</button>
    <button onclick="openShop()">Shop</button>
    <p>High Score: ${data.highScore}</p>
    <p>Coins: ${data.coins}</p>`;
  }

  if(state==="shop"){
    ui.innerHTML=`<h2>Shop</h2>
    ${["lime","red","cyan","gold"].map(c=>
      data.owned.includes(c)?
      `<button onclick="selectSkin('${c}')">${c} âœ“</button>`:
      `<button onclick="buySkin('${c}')">Buy ${c} (50)</button>`
    ).join("")}
    <br><button onclick="state='menu'">Back</button>`;
  }

  if(state==="game"){
    ui.innerHTML="";
    obstacles.forEach(o=>{
      let p=project(o.lane,o.z);
      ctx.fillStyle="red";
      ctx.fillRect(p.x-20*p.scale,p.y-40*p.scale,40*p.scale,60*p.scale);
    });

    coins.forEach(c=>{
      let p=project(c.lane,c.z);
      ctx.fillStyle="gold";
      ctx.beginPath();
      ctx.arc(p.x,p.y,10*p.scale,0,Math.PI*2);
      ctx.fill();
    });

    powerups.forEach(pw=>{
      let p=project(pw.lane,pw.z);
      ctx.fillStyle="cyan";
      ctx.beginPath();
      ctx.arc(p.x,p.y,12*p.scale,0,Math.PI*2);
      ctx.fill();
    });

    // Player sprite
    ctx.fillStyle=data.skin;
    ctx.fillRect(210+currentLane*100-20,player.y,40,60);

    // legs animation
    ctx.strokeStyle="black";
    ctx.beginPath();
    ctx.moveTo(210+currentLane*100-10,player.y+60);
    ctx.lineTo(210+currentLane*100-10,player.y+60+Math.sin(player.frame)*10);
    ctx.moveTo(210+currentLane*100+10,player.y+60);
    ctx.lineTo(210+currentLane*100+10,player.y+60-Math.sin(player.frame)*10);
    ctx.stroke();

    if(shield){
      ctx.strokeStyle="cyan";
      ctx.beginPath();
      ctx.arc(210+currentLane*100,player.y+30,40,0,Math.PI*2);
      ctx.stroke();
    }

    ctx.fillStyle="white";
    ctx.fillText("Score: "+score,10,20);
    ctx.fillText("Coins: "+data.coins,10,40);
  }

  if(state==="gameover"){
    ui.innerHTML=`<h2>Game Over</h2>
    <p>Score: ${score}</p>
    <button onclick="startGame()">Retry</button>
    <button onclick="state='menu'">Menu</button>`;
  }
}

// ===================== SHOP =====================
function openShop(){ state="shop"; }
function buySkin(c){
  if(data.coins>=50){
    data.coins-=50;
    data.owned.push(c);
    save();
  }
}
function selectSkin(c){
  data.skin=c;
  save();
}

// ===================== LOOP =====================
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
</body>
</html>